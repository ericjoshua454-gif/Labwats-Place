<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard | Labwat’s Place</title>

  <!-- Responsive Stylesheets -->
  <link rel="stylesheet" href="desktop.css" media="screen and (min-width: 1025px)">
  <link rel="stylesheet" href="tablet.css" media="screen and (min-width: 768px) and (max-width: 1024px)">
  <link rel="stylesheet" href="mobile.css" media="screen and (max-width: 767px)">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <!-- HEADER -->
  <header class="main-header">
    <h2 class="logo">Labwat’s Admin</h2>
    <nav class="navbar">
      <a href="index.html">Home</a>
      <a href="#" id="logoutBtn">Logout</a>
    </nav>
  </header>

  <!-- DASHBOARD MAIN -->
  <main class="admin-dashboard container">
    <h1>Admin Dashboard</h1>

    <!-- SUMMARY CARDS -->
    <section class="summary-cards">
      <div class="card">
        <h3>Total Orders</h3>
        <p id="totalOrders">0</p>
      </div>
      <div class="card">
        <h3>Total Revenue</h3>
        <p id="totalRevenue">$0</p>
      </div>
      <div class="card">
        <h3>Total Customers</h3>
        <p id="totalCustomers">0</p>
      </div>
    </section>

    <!-- CHARTS -->
    <section class="charts">
      <div class="chart-container">
        <h3>Orders Over Time</h3>
        <canvas id="ordersChart"></canvas>
      </div>
      <div class="chart-container">
        <h3>Revenue Overview</h3>
        <canvas id="revenueChart"></canvas>
      </div>
    </section>

    <!-- ORDERS TABLE -->
    <section class="orders-section">
      <h2>Customer Orders</h2>
      <table class="orders-table">
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Customer</th>
            <th>Item</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="ordersBody"></tbody>
      </table>
      <p id="refreshNotice" style="font-size:0.9em;color:#555;">Last updated: <span id="lastUpdated">-</span></p>
    </section>
  </main>

  <!-- FOOTER -->
  <footer>
    <p>© 2025 Labwat’s Place. All rights reserved.</p>
  </footer>

  <!-- SUPABASE INITIALIZATION -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://lxevlfcvoisxraobthcb.supabase.co"; // your project URL
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx4ZXZsZmN2b2lzeHJhb2J0aGNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NTA4NDcsImV4cCI6MjA3NjUyNjg0N30.2F0G6ojOlHnL9_GspSHlpLYHeAyX3zhJS1e6uGni_KQ"; // your anon/public key
    const { createClient } = supabase;
    window.supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    async function checkAdmin() {
      const { data: { user } } = await window.supabase.auth.getUser();
      if (!user) return window.location.href = "login.html";

      const { data, error } = await window.supabase.from('users')
        .select('role').eq('id', user.id).single();

      if (error || !data || data.role !== 'admin') {
        window.location.href = "dashboard.html";
      }
    }

    checkAdmin();
  </script>

  <!-- JS Files -->
  <script src="main.js"></script>
  <script src="mobile-features.js"></script>
  <script src="tablet-features.js"></script>
  <script src="desktop-features.js"></script>
  <script src="script.js"></script>

  <!-- DASHBOARD SCRIPT WITH AUTO-REFRESH AND CHARTS -->
  <script>
    let ordersChartInstance, revenueChartInstance;

    async function loadAdminDashboard() {
      try {
        const { data: orders, error } = await supabase.from('orders').select('*');

        if (error) return console.error("❌ Error fetching orders:", error);

        // Summary cards
        const totalOrders = orders.length;
        const totalRevenue = orders.reduce((sum, o) => sum + (o.amount || 0), 0);
        const totalCustomers = new Set(orders.map(o => o.customer_name)).size;

        document.getElementById('totalOrders').textContent = totalOrders;
        document.getElementById('totalRevenue').textContent = '₦' + totalRevenue;
        document.getElementById('totalCustomers').textContent = totalCustomers;

        // Orders table
        const ordersBody = document.getElementById('ordersBody');
        ordersBody.innerHTML = '';
        orders.forEach(order => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${order.id}</td>
            <td>${order.customer_name || 'Unknown'}</td>
            <td>${order.item}</td>
            <td>₦${order.amount}</td>
            <td><span class="status ${order.status.toLowerCase()}">${order.status}</span></td>
            <td>
              ${order.status.toLowerCase() === 'pending' ? `<button class="btn-approve">Mark Delivered</button>` : ''}
              <button class="btn-delete">Delete</button>
            </td>
          `;
          ordersBody.appendChild(row);
        });

        // Interactivity
        document.querySelectorAll('.btn-approve').forEach(btn => {
          btn.addEventListener('click', async e => {
            const row = e.target.closest('tr');
            const orderId = row.children[0].textContent;
            await supabase.from('orders').update({ status: 'Delivered' }).eq('id', orderId);
            loadAdminDashboard();
          });
        });

        document.querySelectorAll('.btn-delete').forEach(btn => {
          btn.addEventListener('click', async e => {
            const row = e.target.closest('tr');
            const orderId = row.children[0].textContent;
            await supabase.from('orders').delete().eq('id', orderId);
            loadAdminDashboard();
          });
        });

        // Update last refreshed time
        document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();

        // Prepare chart data
        const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        const ordersPerDay = days.map(day => orders.filter(o => new Date(o.date).toLocaleDateString('en-US', { weekday: 'short' }) === day).length);
        const revenuePerDay = days.map(day => orders
          .filter(o => new Date(o.date).toLocaleDateString('en-US', { weekday: 'short' }) === day)
          .reduce((sum, o) => sum + (o.amount || 0), 0));

        // Orders Chart
        if (ordersChartInstance) ordersChartInstance.destroy();
        const ctx1 = document.getElementById('ordersChart').getContext('2d');
        ordersChartInstance = new Chart(ctx1, {
          type: 'line',
          data: { labels: days, datasets: [{ label: 'Orders', data: ordersPerDay, backgroundColor: 'rgba(54, 162, 235, 0.2)', borderColor: 'rgba(54, 162, 235,1)', borderWidth: 2 }] },
        });

        // Revenue Chart
        if (revenueChartInstance) revenueChartInstance.destroy();
        const ctx2 = document.getElementById('revenueChart').getContext('2d');
        revenueChartInstance = new Chart(ctx2, {
          type: 'bar',
          data: { labels: days, datasets: [{ label: 'Revenue (₦)', data: revenuePerDay, backgroundColor: 'rgba(75, 192, 192, 0.5)', borderColor: 'rgba(75, 192, 192, 1)', borderWidth: 1 }] },
        });

      } catch (err) {
        console.error("Unexpected error:", err);
      }
    }

    loadAdminDashboard();
    setInterval(loadAdminDashboard, 10000); // Refresh every 10 seconds

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = 'login.html';
    });
  </script>
</body>
</html>



